---
title: "Autem Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
```

```{r load, include=FALSE}

# Load data
step_detail_df <- reactive({ read_rds("step_detail.RDS") })
epoch_summary_df <- reactive({ read_rds("epoch_summary.RDS") })
simulation_summary_df <- reactive({ read_rds("simulation_summary.RDS") })
normal_baseline_df <- reactive({ read_rds("normal_baseline.RDS") })
breakdown_df <- reactive({ read_rds("breakdown.RDS") })

all_value = "__all__"

dataset_list <- reactive({ sort(unique(simulation_summary_df()$dataset)) })
breakdown_list <- reactive({ breakdown_df()$breakdown })
filtered_data <- function(.data, .dataset) {
  if (.dataset == all_value)
    .data
  else
    filter(.data, dataset == .dataset)
}

# Formatters
minutes <- scales::unit_format(unit = "min", accuracy = 3)
accuracy <- scales::number_format(accuracy = .01)


```

Sidebar {.sidebar}
=====================================

```{r}

renderUI({
  tagList(
    selectInput("dataset", "Dataset:", dataset_list())
  )
})

```

Summary
=====================================  

Summary Report
-----------------------------------------------------------------------

### Dataset Summary

```{r}

DT::renderDT({
  req(simulation_summary_df(), input$dataset, cancelOutput = TRUE)

  data <- 
    simulation_summary_df() %>%
    mutate(
      `Run time` = minutes(run_time_secs / 60),
      `Rating` = accuracy(rating),
      `Rating SD` = accuracy(rating_sd),
      `Validation` = accuracy(validation_accuracy),
      `Dummy` = accuracy(dummy_accuracy),
      `Min Baseline` = accuracy(min_baseline_accuracy),
      `Max Baseline` = accuracy(max_baseline_accuracy)
    ) %>%
    select(
      experiment, 
      configuration, 
      dataset, 
      status, 
      `Run time`,
      `Rating`,
      `Rating SD`,
      `Dummy`,
      `Validation`,
      `Min Baseline`,
      `Max Baseline`
  )
}, options = list(lengthChange = FALSE))

```

Baselines {data-orientation=columns}
=====================================  

Baselines
-----------------------------------------------------------------------

### Baseline

```{r}

renderPlot({
  req(simulation_summary_df(), cancelOutput = TRUE)
  
  df <- simulation_summary_df()
  min_x <- 0
  max_x <- max(df$normal_rating + df$normal_rating_sd, df$normal_valiation_accuracy)
  max_x <- if (max_x < 1) 1 else max_x

  simulation_summary_df() %>%
    mutate(dataset = forcats::fct_reorder(dataset, desc(normal_rating))) %>%
    ggplot(aes(x = dataset)) +
    geom_errorbar(aes(ymin = normal_rating-normal_rating_sd, ymax=normal_rating+normal_rating_sd), width = 0.5, na.rm = TRUE) +
    geom_point(aes(y = normal_rating, color = "rating")) +
    geom_point(aes(y = normal_validation_accuracy, color = "validation")) +
    ylim(min_x, max_x) +
    coord_flip()

})

```



Normalised
-----------------------------------------------------------------------

### All

```{r}

renderPlot({
  req(simulation_summary_df(), cancelOutput = TRUE)
  
  df <- simulation_summary_df()
  min_x <- 0
  max_x <- max(df$normal_rating + df$normal_rating_sd)
  max_x <- if (max_x < 1) 1 else max_x
  df %>%
  ggplot(aes(x = normal_rating, color  = experiment)) +
    geom_density() +
    xlim(min_x, max_x) +
    xlab("Normalised Rating")

})

```

### Selected

```{r}

renderPlot({
  req(normal_baseline_df(), simulation_summary_df(), input$dataset, cancelOutput = TRUE)
  
  summary_df <- simulation_summary_df() %>% filtered_data(input$dataset)
  min_x <- 0
  max_x <- max(summary_df$normal_rating + summary_df$normal_rating_sd)
  max_x <- if (max_x < 1) 1 else max_x

  baseline_df <- normal_baseline_df() %>% filtered_data(input$dataset)
  rating <- summary_df$rating
  summary_df$baseline_percent <- baseline_df %>% filter(baseline_accuracy <= rating) %>% pull(baseline_percent) %>% max()
  summary_df$normal_baseline_accuracy <- summary_df$normal_rating

  baseline_df %>%
    ggplot(aes(x = baseline_percent, y = normal_baseline_accuracy)) +
    geom_count(color = "DarkGrey") +
    geom_point(data = summary_df, aes(color = "rating"), size = 3) +
    geom_rug(data = summary_df, aes(color = "rating"), sides="trbl") +
    geom_errorbar(data = summary_df, aes(ymin = normal_rating-normal_rating_sd, ymax=normal_rating+normal_rating_sd), width = 0.05, na.rm = TRUE) +
    geom_point(data = summary_df, aes(y = normal_validation_accuracy, color ="validation"), size = 3) +
    geom_hline(data = summary_df, aes(yintercept = normal_max_baseline_accuracy), linetype = 'dotted') +
    geom_hline(data = summary_df, aes(yintercept = normal_dummy_accuracy), linetype = 'dotted') +
    ylim(min_x, max_x) +
    ylab("Normalised Rating")
})

```


Processing
===================================== 

Values
-----------------------------------------------------------------------

### Status

```{r}

renderValueBox({
  req(simulation_summary_df(),input$dataset, cancelOutput = TRUE)
  status <- simulation_summary_df() %>%
    filter(dataset == input$dataset) %>%
    pull(status)
  if (length(status) == 0)
    status <- NULL
  valueBox(status)
})

```

### Runtime

```{r}

renderValueBox({
  req(simulation_summary_df(),input$dataset, cancelOutput = TRUE)
  runtime_secs <- simulation_summary_df() %>% 
    filter(dataset == input$dataset) %>% 
    pull(run_time_secs)
  valueBox(minutes(runtime_secs / 60))
})

```


Epochs
-----------------------------------------------------------------------

### Events

```{r}

renderPlot({
  req(epoch_summary_df(),input$dataset, cancelOutput = TRUE)
  epoch_summary_df() %>% 
    filter(dataset == input$dataset) %>%
    ggplot(aes(x = epoch)) +
    geom_line(aes(y = faults, color = "faults")) +
    geom_line(aes(y = nominations, color = "nominations")) +
    geom_line(aes(y = deaths, color = "deaths")) +
    ylab("Epoch") +
    ylab("Count")
})

```


Steps
-----------------------------------------------------------------------

### Accuracy

```{r}

renderPlot({
  req(step_detail_df(),input$dataset, cancelOutput = TRUE)
  step_detail_df() %>% 
    filter(dataset == input$dataset, !is.na(accuracy)) %>%
    ggplot(aes(x = step, y = accuracy)) +
    geom_point(size = 0.5)
})

```

### Duration

```{r}

renderPlot({
  req(step_detail_df(),input$dataset, cancelOutput = TRUE)
  step_detail_df() %>% 
    filter(dataset == input$dataset, !is.na(accuracy)) %>%
    ggplot(aes(x = step, y = duration)) +
    geom_point(size = 0.5)
})

```

