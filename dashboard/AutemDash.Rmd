---
title: "Autem Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cosmo
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
```

```{r load, include=FALSE}
 
# Load data
step_detail_rdf <- reactive({ read_rds("data\\step_detail.RDS") })
epoch_detail_rdf <- reactive({ read_rds("data\\epoch_detail.RDS") })
simulation_summary_rdf <- reactive({ read_rds("data\\simulation_summary.RDS") })
dataset_summary_rdf <- reactive({ read_rds("data\\dataset_summary.RDS") })
baseline_detail_rdf <- reactive({ read_rds("data\\baseline_detail.RDS") })
baseline_summary_rdf <- reactive({ read_rds("data\\baseline_summary.RDS") })
breakdown_rdf <- reactive({ read_rds("data\\breakdown.RDS") })

all_value = "__all__"

experiment_rlist <- reactive({ sort(unique(simulation_summary_rdf()$experiment)) })
breakdown_rlist <- reactive({ breakdown_rdf()$breakdown })

filtered_data <- function(.data, .experiment) {
  if (.experiment == all_value)
    .data
  else
    filter(.data, experiment == .experiment)
}

# Formatters
minutes_format <- scales::unit_format(unit = "min", accuracy = 3)
accuracy_format <- scales::number_format(accuracy = .01)

```

Sidebar {.sidebar}
=====================================

```{r}

renderUI({
  tagList(
    selectInput("experiment", "Experiment:", experiment_rlist()),
    selectInput("breakdown", "Breakdown 1:", breakdown_rlist()),
    selectInput("breakdown2", "Breakdown 2:", breakdown_rlist())
  )
})

```

Overview {data-orientation=columns}
=====================================  

Overview
-----------------------------------------------------------------------

### All

```{r}

DT::renderDataTable({
  
  req(simulation_summary_rdf(), cancelOutput = TRUE)
  
  simulation_summary_df <- simulation_summary_rdf()
  
  output_df <- 
    simulation_summary_df %>%
    mutate(
      score = readr::parse_number(format(score, digits = 3)),
      progress_top_score = readr::parse_number(format(progress_top_score, digits = 3)),
      progress = readr::parse_number(format(progress, digits = 3))
    ) %>%
    select(
      Experiment = experiment,
      Study = study,
      Status = status,
      Steps = steps,
      `Duration (s)` = duration,
      Score = score,
      `Target Score` = progress_top_score,
      Progress = progress
    )
  
  DT::datatable(output_df)
  
})

```

Summary {data-orientation=columns}
=====================================  

### Status

```{r}

DT::renderDataTable({
  req(simulation_summary_rdf(), input$experiment, cancelOutput = TRUE)
  
  simulation_summary_df <- simulation_summary_rdf() %>% filtered_data(input$experiment)
  
  output_df <- 
    simulation_summary_df %>%
    mutate(
      score = readr::parse_number(format(score, digits = 3)),
      progress_top_score = readr::parse_number(format(progress_top_score, digits = 3)),
      progress = readr::parse_number(format(progress, digits = 3))
    ) %>%
    select(
      Experiment = experiment,
      Study = study,
      Status = status,
      Steps = steps,
      `Duration (s)` = duration,
      Score = score,
      `Target Score` = progress_top_score,
      Progress = progress
    )
  
  DT::datatable(output_df, options = list(bPaginate = FALSE, bFilter = FALSE))

})

```

### Data

```{r}

DT::renderDataTable({
  req(dataset_summary_rdf(), input$experiment, cancelOutput = TRUE)
  
  experiment = input$experiment
  
  dataset_summary_df <- dataset_summary_rdf() %>% filter(dataset == experiment)
  output_df <- 
    dataset_summary_df %>%
    select(
      Dataset = dataset,
      Classes = classes,
      Features = features,
      Instances = instances,
      Incomplete = incomplete,
      Missing = missing
    )
  
  DT::datatable(output_df, options = list(bPaginate = FALSE, bFilter = FALSE))

})

```

"study"                 "experiment"            "dataset"               "status"                "classes"               "features"              "instances"            
 [8] "incomplete_instances"  "missing_values"        "duration"              "epochs"                "steps"                 "score"                 "score_sd"             
[15] "dummy_score"           "validation_score"      "baseline_bottom_score" "baseline_top_score"    "progress_bottom_score" "progress_top_score"    "progress"             
[22] "progress_sd"

Baselines {data-orientation=columns}
=====================================  

Left
-----------------------------------------------------------------------

### All progress

```{r}

renderPlot({
  req(simulation_summary_rdf(), cancelOutput = TRUE)

  df <- simulation_summary_rdf() %>% filter(!is.na(progress))

  p <- df %>%
    mutate(experiment = forcats::fct_reorder(experiment, desc(progress))) %>%
    ggplot(aes(x = experiment, color = study)) +
    geom_point(aes(y = progress)) +
    ylab("Progress") +
    coord_flip()
  p

})

```

Right
-----------------------------------------------------------------------

### Progress Density

```{r}

renderPlot({
  req(simulation_summary_rdf(), cancelOutput = TRUE)
  
  df <- simulation_summary_rdf() %>% filter(!is.na(progress))
  p <- df %>%
    ggplot(aes(x = progress, color = study)) +
    geom_density() +
    xlab("Progress") +
    ylab("Density")
  p

})

```

### Experiment Progress

```{r}

renderPlot({
  req(simulation_summary_rdf(), baseline_detail_rdf(), input$experiment, cancelOutput = TRUE)
  
  experiment = input$experiment
  
  simulation_summary_df <- simulation_summary_rdf() %>% filtered_data(experiment)
  simulation_summary_df <-
    simulation_summary_df %>%
    mutate(validation_progress = (validation_score - progress_bottom_score) / (progress_top_score - progress_bottom_score))
  
  baseline_detail_df <- baseline_detail_rdf() %>% filter(dataset == simulation_summary_df$dataset)
  
  baseline_progress_df <-
    simulation_summary_df %>%
    right_join(baseline_detail_df, by = c("dataset")) %>%
    mutate(
      baseline_progress = (baseline_score - progress_bottom_score) / (progress_top_score - progress_bottom_score)
    ) %>%
    select(study, experiment, baseline_score, baseline_rank, baseline_percent, baseline_progress) %>%
    filter(baseline_progress >= 0)
  
  simulation_summary_progress <-
    simulation_summary_df %>%
    full_join(baseline_progress_df, by = c("study", "experiment")) %>%
    filter(baseline_score <= score) %>%
    group_by(study, experiment) %>%
    summarise(baseline_rank = max(baseline_rank), baseline_percent = max(baseline_percent))
  
  simulation_summary_df <- 
    simulation_summary_df %>%
    full_join(simulation_summary_progress, by = c("study", "experiment"))
  
  baseline_progress_df %>%
      ggplot() +
      geom_count(aes(x = baseline_percent, y = baseline_progress), color = "DarkGrey") +
      geom_point(data = simulation_summary_df, aes(x = baseline_percent, y = progress, color = study, shape ="score"), size = 3) +
      geom_rug(data = simulation_summary_df, aes(x = baseline_percent, y = progress, color = study), sides="trbl") +
      geom_errorbar(data = simulation_summary_df, aes(x = baseline_percent, ymin = progress-progress_sd, ymax=progress+progress_sd), width = 0.05, na.rm = TRUE) +
      geom_point(data = simulation_summary_df, aes(x = baseline_percent, y = validation_progress, color = study, shape ="validation"), size = 3) +
      geom_hline(aes(yintercept = 1.0), linetype = 'dotted') +
      geom_hline(aes(yintercept = 0.0), linetype = 'dotted') +
      xlim(0.0, 1.0) +
      xlab("Baseline rank") +
      ylab("Progress")
})

```

Validation {data-orientation=columns}
=====================================  

Long
-----------------------------------------------------------------------

### All Details

```{r}

renderPlot({
  req(simulation_summary_rdf(), cancelOutput = TRUE)

  simulation_summary_df <- simulation_summary_rdf() %>% filter(!is.na(validation_score))

  output_df <-
    simulation_summary_df %>%
    mutate(
      validation_distance = (validation_score - score) / score_sd
    ) %>%
    filter(!is.na(validation_distance)) %>%
    mutate(
      experiment = forcats::fct_reorder(experiment, abs(validation_distance))
    ) %>%
    select(
      study,
      experiment,
      dataset,
      score,
      score_sd,
      validation_score,
      validation_distance
    )

  output_df %>%
    ggplot(aes(x = experiment, color = study)) +
    geom_point(aes(y = validation_distance)) +
    geom_hline(aes(yintercept = 0), linetype = 'solid') +
    geom_hline(aes(yintercept = -1), linetype = 'dotdash') +
    geom_hline(aes(yintercept = 1), linetype = 'dotdash') +
    geom_hline(aes(yintercept = -2), linetype = 'dotted') +
    geom_hline(aes(yintercept = 2), linetype = 'dotted') +
    coord_flip()
  
})

```

Compact
-----------------------------------------------------------------------

### Validation Density

```{r}
renderPlot({
  req(simulation_summary_rdf(), cancelOutput = TRUE)

  simulation_summary_df <- simulation_summary_rdf() %>% filter(!is.na(validation_score))

  output_df <-
    simulation_summary_df %>%
    mutate(
      validation_distance = (validation_score - score) / score_sd
    ) %>%
    filter(!is.na(validation_distance)) %>%
    mutate(
      experiment = forcats::fct_reorder(experiment, desc(abs(validation_distance)))
    ) %>%
    select(
      study,
      experiment,
      dataset,
      score,
      score_sd,
      validation_score,
      validation_distance
    )

  output_df %>%
    ggplot(aes(x = validation_distance, color = study)) +
    geom_density()
})

```

### Selected Validation

```{r}

renderPlot({
  req(simulation_summary_rdf(), input$experiment, cancelOutput = TRUE)

  experiment <- input$experiment
  simulation_summary_df <- simulation_summary_rdf() %>% filtered_data(experiment)

  output_df <-
    simulation_summary_df %>%
    select(
      study,
      experiment,
      dataset,
      score,
      score_sd,
      validation_score
    )
  
  output_df %>%
    ggplot(aes(x = study)) +
    geom_errorbar(aes(ymin = score-score_sd, ymax=score+score_sd), width = .3, color = "black") +
    geom_errorbar(aes(ymin = score-score_sd * 2, ymax=score+score_sd* 2), width = .15, color = "black", linetype = 'dotted') +
    geom_point(aes(y = score, color = "score"), size = 3) +
    geom_point(aes(y = validation_score, color = "validation"), size = 3) +
    coord_flip() +
    xlab("Study") +
    ylab("Score")

})
```

Scores {data-orientation=rows}
=====================================

Step score
-----------------------------------------------------------------------

```{r}

renderPlot({
  req(step_detail_rdf(), simulation_summary_rdf(), input$experiment, input$breakdown, cancelOutput = TRUE)
  
  step_detail_df <- 
    step_detail_rdf() %>% 
    filtered_data(input$experiment) %>%
    filter(!is.na(score)) %>%
    group_by(member_id, league) %>%
    filter(step == min(step)) %>%
    mutate(
      predicted_score = choice_predicted_score,
      predicted_score_std = choice_predicted_score_std
    ) %>%
    ungroup()
  simulation_summary_df <- simulation_summary_rdf() %>% filtered_data(input$experiment)
  
  req(nrow(step_detail_df) > 0, cancelOutput = TRUE)  
  
  step_detail_df %>%
    ggplot(aes(x = step)) +
    geom_point(size = 3, aes(y = predicted_score), shape=1, color = "Grey", na.rm = TRUE) +
    geom_point(size = 1, aes(y = score, color = !!as.symbol(input$breakdown)), na.rm = TRUE) +
    geom_hline(data = simulation_summary_df, aes(yintercept = baseline_top_score), linetype = 'dotted') +
    geom_label(data = simulation_summary_df, aes(x = 0, y = baseline_top_score, label = accuracy_format(baseline_top_score))) +
    geom_hline(data = simulation_summary_df, aes(yintercept = dummy_score), linetype = 'dotted') +
    geom_label(data = simulation_summary_df, aes(x = 0, y = dummy_score, label = accuracy_format(dummy_score))) +
    facet_wrap(~ study) +
    coord_cartesian(ylim = c(0, 1))
})

```

Durations {data-orientation=rows}
=====================================

Step duration
-----------------------------------------------------------------------

```{r}

renderPlot({
  req(step_detail_rdf(), simulation_summary_rdf(), input$experiment, input$breakdown, cancelOutput = TRUE)
  
  step_detail_df <- 
    step_detail_rdf() %>% 
    filtered_data(input$experiment) %>% 
    filter(!is.na(duration))
  simulation_summary_df <- simulation_summary_rdf() %>% filtered_data(input$experiment)
  
  step_detail_df %>%
    ggplot(aes(x = step, y = duration)) +
    geom_point(size = 0.5, aes(color = !!as.symbol(input$breakdown))) +
    facet_wrap(~ study)
})

```

Components {data-orientation=rows}
=====================================

Top
-----------------------------------------------------------------------

### Counts

```{r}

renderPlot({
  req(breakdown_rlist(), step_detail_rdf(), input$experiment, cancelOutput = TRUE)
  
  step_detail_df <- step_detail_rdf() %>% filtered_data(input$experiment) %>% filter(final == 1)
  choices_list <- breakdown_rlist()
  
  req(nrow(step_detail_df) > 0, cancelOutput = TRUE)
  
  build_component_summary <- function(.choice) { 
    step_detail_df %>% 
      group_by_at(c("study", "experiment", .choice)) %>% 
      summarise(n = n()) %>%
      mutate(choice = .choice) %>%
      select(study, experiment, choice, component = !! .choice, n)
  }
  
  choices_summary_df <-  
    purrr::map_dfr(choices_list,  build_component_summary) %>%
    mutate(choice = factor(choice))
  
  choices_summary_df %>%
    ggplot() +
    geom_col(aes(x = forcats::fct_reorder(component, choice, .fun = unique, .desc = TRUE), y = n, fill = choice)) + 
    coord_flip() +
    xlab("Component") +
    facet_wrap(~ study)
})
```

### Scores 

```{r}

renderPlot({
  req(breakdown_rlist(), step_detail_rdf(), input$experiment, cancelOutput = TRUE)
  
  step_detail_df <- step_detail_rdf() %>% filtered_data(input$experiment) %>% filter(final == 1)
  choices_list <- breakdown_rlist()
  
  req(nrow(step_detail_df) > 0, cancelOutput = TRUE)
  
  build_choice_scores <- function(choice) { 
    step_detail_df %>% 
      mutate(
        choice = choice,
        predicted_score = choice_predicted_score
      ) %>%
      select(study, experiment, choice, component = !! choice, score, predicted_score)
  }
  
  choices_score_df <-  
    purrr::map_dfr(choices_list,  build_choice_scores) %>%
    mutate(
      choice = factor(choice),
      component = forcats::fct_reorder(component, choice, .fun = unique, .desc = TRUE)
    )

  choices_score_df %>%
    ggplot() +
    geom_point(aes(x = component, y = predicted_score), size = 3, shape=1, color = "Grey", na.rm = TRUE) +
    geom_point(aes(x = component, y = score, color = choice), size = 1, na.rm = TRUE) +
    coord_flip() +
    xlab("Component") +
    facet_wrap(~ study)

})

```

Bottom
-----------------------------------------------------------------------

### Duration

```{r}
renderPlot({
  req(breakdown_rlist(), step_detail_rdf(), input$experiment, cancelOutput = TRUE)
  
  step_detail_df <- step_detail_rdf() %>% filtered_data(input$experiment) %>% filter(!is.na(duration))
  choices_list <- breakdown_rlist()
  
  req(nrow(step_detail_df) > 0, cancelOutput = TRUE)
  
  build_choice_durations <- function(.choice) { 
    step_detail_df %>% 
      mutate(
        choice = .choice
      ) %>%
      select(study, experiment, choice, component = !! .choice, duration)
  }
  
  durations_score_df <-  
    purrr::map_dfr(choices_list,  build_choice_durations) %>%
    mutate(
      choice = factor(choice),
      component = forcats::fct_reorder(component, choice, .fun = unique, .desc = TRUE)
  )
  
  durations_score_df %>%
    ggplot() +
    geom_point(aes(x = component, y = duration, color = choice)) + 
    coord_flip() +
    xlab("Component") +
    facet_wrap(~ study)

})

```

### Place

Components X {data-orientation=rows}
=====================================

Bottom
-----------------------------------------------------------------------

### Score grid

```{r}

renderPlot({
  req(breakdown_rlist(), step_detail_rdf(), input$experiment, input$breakdown, input$breakdown2, cancelOutput = TRUE)
  
  .choice1 <- input$breakdown
  .choice2 <- input$breakdown2

  step_detail_df <- step_detail_rdf() %>% filtered_data(input$experiment) %>% filter(final == 1)
  req(nrow(step_detail_df) > 0, cancelOutput = TRUE)

  choice2_detail_df <-
    step_detail_df %>% 
    mutate(
      component1 = !! sym(.choice1),
      component2 = !! sym(.choice2),
      predicted_score = choice_predicted_score,
      predicted_score_std = choice_predicted_score_std
    ) %>%
    select(study, experiment, component1, component2, score, score_std, predicted_score, predicted_score_std)

  choice2_detail_df %>%
    ggplot() +
    geom_point(aes(x = component2, y = predicted_score), size = 3, shape=1, color = "Grey", na.rm = TRUE) +
    geom_point(aes(x = component2, y = score), size = 1, na.rm = TRUE) +
    facet_wrap(component1 ~ study) +
    coord_flip()

})

```


